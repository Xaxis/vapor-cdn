/*!
 * vcdn - v1.0.0
 * Wil Neeley Â© 2015
 */
var vcdn=function(a){return document.write('<script src="/socket.io/socket.io.js/"></script>'),a}(vcdn||{},window);!function(a,b){return a.Global={asset_attrib:"data-vcdn",base_url:"/",cache_prefix:"vapor.",chunk_size:1e6,debug:!0,default_trace_msg:"module_name: ",environment_stable:function(){var a=!0,b={webrtc_1:[window.RTCPeerConnection,window.mozRTCPeerConnection,window.webkitRTCPeerConnection],webrtc_2:[window.mozRTCIceCandidate,window.RTCIceCandidate],webrtc_3:[window.RTCSessionDescription,window.mozRTCSessionDescription,window.RTCSessionDescription],webrtc_4:[navigator.getUserMedia,navigator.mozGetUserMedia,navigator.webkitGetUserMedia],storage:[window.localStorage,window.sessionStorage],time:[window.Date.now]};for(var c in b){for(var d=b[c],e=!1,f=0;f<d.length;f++)d[f]&&(e=!0);e||(a=!1)}return a}(),header_length:2222,init_info:null,peer_asset_connections:{},p2pc:{dc_config:{ordered:!0,reliable:!1},p2pc_config:{optional:[{DtlsSrtpKeyAgreement:!0},{RtpDataChannels:!0}]},stun_config:{iceServers:[{url:"stun:23.21.150.121"},{url:"stun:stun.l.google.com:19302"}]}},socket:null,storage:{},storage_mode:"session",super_globals:function(){var a={PeerConnection:window.RTCPeerConnection||window.mozRTCPeerConnection||window.webkitRTCPeerConnection,IceCandidate:window.mozRTCIceCandidate||window.RTCIceCandidate,SessionDescription:window.RTCSessionDescription||window.mozRTCSessionDescription||window.RTCSessionDescription,getUserMedia:navigator.getUserMedia||navigator.mozGetUserMedia||navigator.webkitGetUserMedia,IndexedDB:window.indexedDB||window.mozIndexedDB||window.webkitIndexedDB||window.msIndexedDB,IDBTransaction:window.IDBTransaction||window.webkitIDBTransaction||window.msIDBTransaction,IDBKeyRange:window.IDBKeyRange||window.webkitIDBKeyRange||window.msIDBKeyRange};for(var c in a)b[c]=a[c];return!0}(),unload:{prompt:!1,message:"Disconnecting will prevent users from receiving website assets. Continue?"},watcher:{assets:null,elapsed:0,interval:null,global_speed:50,global_timeout:5e4,request_speed:50,request_timeout:5e3,finished:!0,chunk_timeout_multiple:4},wire:{bytes_sent:0,bytes_received:0}},a}(vcdn||{},window),function(a){return a.Util={},a.Util.timestamp=function(a){return a?Date.now()+a:Date.now()},a.Util.keys=function(a){var b=[];for(var c in a)a.hasOwnProperty(c)&&b.push(c);return b},a.Util.first=function(a){var b=null;for(var c in a){b=a[c];break}return b},a.Util.each=a.Util.forEach=function(a,b){if(null!=a)if(a.forEach)a.forEach(b);else if(a instanceof Array){for(var c=0;c<a.length;c++)if(b.call(a[c],a[c],c,a)===!1)return}else for(var d in a)if(a.hasOwnProperty(d)&&b.call(a[d],a[d],d,a)===!1)return},a.Util.merge=a.Util.extend=function(){var b=a.Util.toArray(arguments),c=b.shift();return b.forEach(function(a){for(var b in a)a.hasOwnProperty(b)&&(c[b]=a[b])}),c},a.Util.toArray=function(a){var b=[];for(var c in a)a.hasOwnProperty(c)&&b.push(a[c]);return b},a.Util.arrayValuesEqual=function(a,b){for(var c=0;c<b.length;c++){var d=b[c];if(-1==a.indexOf(d))return!1}return!0},a.Util.getArrayValuesEqual=function(a,b){for(var c=[],d=0;d<b.length;d++){var e=b[d];-1!=a.indexOf(e)&&c.push(e)}return c},a.Util.arrayRemoveDuplicates=function(a){for(var b=[],c=0;c<a.length;c++){var d=a[c];-1==b.indexOf(d)&&b.push(d)}return b},a.Util.diffArray=function(a,b){var c=[],d=[a,b];return d.forEach(function(a,b){a.forEach(function(a,e){0==b?-1==d[1].indexOf(a)&&c.push(d[0][e]):-1==d[0].indexOf(a)&&c.push(d[1][e])})}),c},a.Util.ab2str=function(a){return String.fromCharCode.apply(null,new Uint8Array(a))},a.Util.str2ab=function(a){for(var b=new ArrayBuffer(a.length),c=new Uint8Array(b),d=0,e=a.length;e>d;d++)c[d]=a.charCodeAt(d);return b},a.Util.get=function(a){var b=new XMLHttpRequest;b.open("GET",a.uri,!0),b.responseType=a.responseType||"text",b.onreadystatechange=function(c){4==b.readyState&&200==b.status&&a.success.apply(this,[c.target.response,a.elm,c,a])},b.send()},a.Util.padString=function(a,b,c){return a+Array(Math.abs(a.length-(c+1))).join(b)},a}(vcdn||{}),function(a){return a.Log={trace:function(){if(a.Global.debug){var b=arguments;console.log.apply(console,b)}}},a}(vcdn||{}),function(a){return a.Cache={localStorage:function(){switch(a.Global.storage_mode){case"session":return window.sessionStorage;case"local":return window.localStorage}}(),addLocalStorage:function(b,c){var d=JSON.stringify(c),b=a.Global.cache_prefix+b;this.localStorage.setItem(b,d)},getLocalStorage:function(b,c){return b=c?b:a.Global.cache_prefix+b,JSON.parse(this.localStorage.getItem(b))},getAllLocalStorage:function(b){var c=[],d=a.Cache.getLocalStorageKeys();return d.forEach(function(d){var e=b?a.Global.cache_prefix+b:a.Global.cache_prefix,f=new RegExp("^"+e,"g");f.test(d)&&c.push(a.Cache.getLocalStorage(d,!0))}),c},getLocalStorageKeys:function(){return a.Util.keys(this.localStorage)},deleteLocalStorage:function(a){this.localStorage.removeItem(a)},deleteAllLocalStorage:function(b){var c=b?a.Global.cache_prefix+b:a.Global.cache_prefix,d=a.Cache.getLocalStorageKeys();d.forEach(function(b){var d=new RegExp(c,"g");d.test(b)&&a.Cache.deleteLocalStorage(b)})},doesStorageObjectExist:function(b){return a.Cache.getLocalStorage(b)?!0:!1},doFileAssetsExist:function(){var b=a.Cache.getAllLocalStorage("file");return b.length?!0:!1},getCacheableAssets:function(b){b=b||"[data-vcdn]";var c=[],d=document.querySelector("html"),e=a.Util.toArray(d.querySelectorAll(b));return e.forEach(function(a){"number"!=typeof a&&""!==a.getAttribute("data-vcdn")&&c.push(a)}),c},forEachCacheableAsset:function(b){var c=a.Cache.getCacheableAssets();c.forEach(function(c,d){var e=a.Cache.getAssetUri(c);b.apply(this,[c,e,d])})},getCacheableAssetList:function(){var b=[];return a.Cache.forEachCacheableAsset(function(a,c){b.push(c)}),b},getCachedAssetList:function(){var b=[];return a.Cache.forEachCachedAsset(function(a){b.push(a.name)}),b},getAssetUriAttribute:function(a){var b=a.nodeName.toLowerCase(),c="";switch(!0){case"link"==b:c="href";break;case"img"==b||"script"==b:c="src"}return c},getAssetResponseType:function(a){var b=a.nodeName.toLowerCase(),c="";switch(!0){case"link"==b:c="text";break;case"script"==b:c="text";case"img"==b:c="arraybuffer"}return c},loadAssetToDom:function(b,c){var d=new Blob([c]),e=URL.createObjectURL(d);return b.forEach(function(b){b.setAttribute(a.Cache.getAssetUriAttribute(b),e),b.removeAttribute("data-vcdn-duplicate")}),URL.revokeObjectURL(e),d},getAssetFromServer:function(b,c){var d=b.getAttribute("data-vcdn"),e=a.Cache.getCacheableAssets('[data-vcdn="'+d+'"]'),f=e.length;f>1&&!b.getAttribute("data-vcdn-duplicate")&&e[0].setAttribute("data-vcdn-duplicate","true"),b.getAttribute(a.Cache.getAssetUriAttribute(b))||!b.getAttribute("data-vcdn-duplicate")&&(1!=f||b.getAttribute("data-vcdn-duplicate"))||a.Util.get({uri:d,elm:b,responseType:a.Cache.getAssetResponseType(b),success:function(b,f){var g=a.Cache.loadAssetToDom(e,b);a.Cache.cacheAsset({elm:f,blob:g,data:"string"==typeof b?b:null,cache:"string"==typeof b}),c.apply(this,[f,d])}})},getAllAssetsFromServer:function(b){var c=b.list||[],d=b.onReady;a.Cache.forEachCacheableAsset(function(b){var e=a.Cache.getAssetUri(b),f=a.Cache.getFileAssetByName(e);f||-1==c.indexOf(e)||a.Cache.getAssetFromServer(b,d)})},cacheAsset:function(b){var c="file."+a.Cache.getAssetUri(b.elm),d=a.Global.cache_prefix+c,e=a.Cache.chunkifyAsset({asset:{data:b.blob,size:b.blob.size},chunk_size:a.Global.chunk_size});a.Global.storage[d]={id:d,chunks:e},b.cache&&!a.Cache.getLocalStorage(c,!0)&&a.Cache.addLocalStorage(c,{id:a.Global.cache_prefix+c,name:a.Cache.getAssetUri(b.elm),data:b.data})},chunkifyAsset:function(a){var b=a.asset.data,c=a.asset.size-1,d=a.chunk_size,e=Math.ceil(c/a.chunk_size),f=0,g=[];for(f;e>f;f++){var h=f*d,i=h+d,j=b.slice(h,i),k=a.callback?a.callback(j):j;g.push(k)}return g},getFileAssetByName:function(b){var c=null,d=a.Cache.getAllLocalStorage("file");return d.forEach(function(a){return a.name==b?(c=a,!0):void 0}),c},getAssetUri:function(a){return a.getAttribute("data-vcdn")},forEachCachedAsset:function(b){var c=a.Cache.getAllLocalStorage("file");c.forEach(function(a,c){b.apply(this,[a,c])})},uncacheDeadAssets:function(){a.Cache.forEachCachedAsset(function(b){var c=a.Cache.getCacheableAssets(['[data-vcdn="'+b.name+'"]']);c.length||a.Cache.deleteLocalStorage(b.id)})},loadAllCachedAssets:function(){a.Cache.forEachCachedAsset(function(b){var c=a.Cache.getCacheableAssets('[data-vcdn="'+b.name+'"]'),d=a.Cache.loadAssetToDom(c,b.data);a.Cache.cacheAsset({elm:c[0],blob:d,data:b.data,cache:!0})})}},a}(vcdn||{}),function(a){return a.Serve={},a.Serve.requests={},a.Serve.request_watchers={},a.Serve.unload=function(){window.document.addEventListener("click",function(){a.Util.forEach(a.Global.peer_asset_connections,function(b,c){if(c!=a.Global.init_info.self.id){var d=b.channels.peerAssetsConnection;d.close()}})}),window.addEventListener("beforeunload",function(b){return a.Util.forEach(a.Global.peer_asset_connections,function(b,c){if(c!=a.Global.init_info.self.id){var d=b.channels.peerAssetsConnection;d.close()}}),clearInterval(a.Global.watcher.interval),a.Global.unload.prompt?void(b.returnValue=a.Global.unload.message):!1})}(),a.Serve.registerAsHost=function(b){a.Log.trace("Registering as ready host.",b.assets);var c=b.assets||{},d={};for(var e in c)d[e]={chunk_total:c[e].chunks.length};var f={limit:10,assets:d};b.ready&&(f.ready=!0,f.diff_time=a.Global.init_info.self.diff_time),a.Global.socket.emit("register",f)},a.Serve.startAssetRequestListener=function(b){var c=b.id,d=b.id_prefix||"",e=b.socket,f=d+c,g=a.Global.peer_asset_connections[f]=a.Global.peer_asset_connections[f]||a.P2PC({id:c,signal:a.P2PS({socket:e})});return g.newListeningChannel({channel_id:"peerAssetsConnection",onDataChannelReady:function(c){a.Log.trace("onDataChannelReady:",c),b.handleRequest?b.handleRequest.call(this,c):c.channel.send(JSON.stringify(b.message))}}),g},a.Serve.getPeerHostedAssetsList=function(b){var c=[];return a.Util.forEach(b,function(b){a.Util.forEach(b.assets,function(a,b){var d=b.replace(/^vapor\.file\./,"");-1==c.indexOf(d)&&c.push(d)})}),c},a.Serve.buildAssetsRequestMessage=function(b){var c={},d=b.hosts,e=b.assets,f=d.length;return e.forEach(function(b){var e=1;d.forEach(function(d,g){var h=a.Global.cache_prefix+"file."+b;if(a.Global.cache_prefix+"file."+b in d.assets){var i=d.assets[h].chunk_total,j=f>i?i:f,k=Math.floor(i/j),l=i%j,m=g*k,n=m+k;if(c[d.id]=c[d.id]||{},c[d.id][b]={chunks:[]},i>=e)for(var o=m;n>o;o++)c[d.id][b].chunks.push(e),e++;if(l&&0==g)for(var p=0;l>p;p++)c[d.id][b].chunks.push(e),e++}})}),c},a.Serve.buildAssetsRequestTracker=function(b){var c={};return a.Util.forEach(b,function(b){a.Util.forEach(b,function(b,d){c[d]=c[d]||{id:d};var e=c[d].chunks_pending?c[d].chunks_pending.concat(b.chunks):b.chunks;c[d].chunks_pending=e,c[d].chunks_received=[],c[d].chunks=[],c[d].watcher=c[d].watcher||{id:d,speed:a.Global.watcher.request_speed,timeout:a.Global.watcher.request_timeout,elapsed:0,watcher:null,finished:!1},c[d].watcher.watcher=c[d].watcher.watcher||a.Serve.startAssetWatcher.call(c[d])})}),c},a.Serve.startAssetWatcher=function(){var b=this;return setInterval(function(){if(b.watcher.elapsed+=a.Global.watcher.request_speed,b.watcher.elapsed>=a.Global.watcher.request_timeout&&(console.log("Asset watcher timed out!",b),clearInterval(b.watcher.watcher)),b.chunks_pending.length==b.chunks_received.length){var c=a.Cache.getCacheableAssets("["+a.Global.asset_attrib+'="'+b.id+'"]'),d=b.chunks,e=new Blob(d);clearInterval(b.watcher.watcher),a.Cache.loadAssetToDom(c,e),a.Cache.cacheAsset({elm:c[0],blob:e}),b.watcher.finished=!0,a.Log.trace("startAssetWatcher",b.id+" loaded and cached.")}},b.watcher.speed)},a.Serve.startGlobalAssetWatcher=function(b){var c=a.Util.keys(a.Global.watcher.assets),d=c.length,e=[];return setInterval(function(){if(a.Global.watcher.elapsed+=a.Global.watcher.global_speed,a.Global.watcher.elapsed>=a.Global.watcher.global_timeout&&(a.Log.trace("startGlobalAssetWatcher","Global watcher expired!"),a.Global.watcher.elapsed=0,clearInterval(a.Global.watcher.interval)),b)for(var c in b){var f=b[c];f.watcher.finished&&!a.Global.watcher.assets[c].finished&&(a.Global.watcher.assets[c].finished=!0)}for(var c in a.Global.watcher.assets){var g=a.Global.watcher.assets[c];g.finished&&-1==e.indexOf(c)&&e.push(c),e.length==d&&(clearInterval(a.Global.watcher.interval),a.Serve.registerAsHost({ready:!0,assets:a.Global.storage}))}},a.Global.watcher.global_speed)},a.Serve.initGlobalStatusWatcher=function(b){a.Global.watcher.assets=a.Serve.buildAssetsRequestList(b),a.Global.watcher.interval=a.Util.keys(a.Serve.request_watchers).length?a.Serve.startGlobalAssetWatcher(a.Serve.request_watchers):a.Serve.startGlobalAssetWatcher()},a.Serve.handleSendingAssetRequest=function(b){var c=JSON.parse(b.data);for(var d in c){var e=c[d],f=a.Global.cache_prefix+"file."+d,g=a.Global.storage[f].chunks;e.chunks.forEach(function(c){var d=g[c-1],e=c+":"+g.length+":"+a.Util.timestamp(-a.Global.init_info.self.diff_time)+":"+f,h=new Blob([a.Util.str2ab(a.Util.padString(e,"/",a.Global.header_length))]),i=new Blob([h,d]);b.channel.send(i),a.Global.wire.bytes_sent+=i.size,a.Global.peer_asset_connections[b.message.client_id]||(a.Global.peer_asset_connections[b.message.client_id]={id:b.message.client_id,channels:{peerAssetsConnection:b.channel}})})}},a.Serve.handleReceivingRequest=function(b){if(-1==a.Global.init_info.expired.indexOf(b.peer_id)){var c=b.data;a.Global.bytes_received+=c.size,a.Serve.receiveAssetChunk(c,function(c){var d=c.chunk_timestamp,e=a.Util.timestamp(-a.Global.init_info.self.diff_time),f=(Math.abs(d-e),c.id),g=f.replace(a.Global.cache_prefix+"file.",""),h=a.Serve.request_watchers[g],i=c.chunk_id,j=c.chunk,k=h.chunks,l=(c.chunk_total,h.chunks_received),m=(a.Serve.request_watchers[g].watcher,a.Serve.requests[b.peer_id][g]);m.chunks_received=m.chunks_received||[];(m.chunks_received?m.chunks_received.length:1)+1;l.push(i),m.chunks_received.push(i),k[i-1]=j})}},a.Serve.receiveAssetChunk=function(b,c){var d=b.slice(0,a.Global.header_length),e=b.slice(a.Global.header_length,b.size),f=new FileReader;f.onload=function(){var b=a.Util.ab2str(this.result).replace(/\/*$/,""),d=b.indexOf(":"),f="",g="";d=b.substring(0,d),b=b.substring(d.length+1,b.length),f=b.indexOf(":"),f=b.substring(0,f),b=b.substring(f.length+1,b.length),g=b.indexOf(":"),g=b.substring(0,g),b=b.substring(g.length+1,b.length);var h={id:b,chunk:e,chunk_id:parseInt(d),chunk_total:parseInt(f),chunk_timestamp:g};c.apply(this,[h])},f.readAsArrayBuffer(d)},a.Serve.getPeerHostInfo=function(b){for(var c=a.Global.init_info.hosts,d=c.length,e=null,f=0;d>f;f++){var g=c[f];if(g.id==b){e={index:f,host:g};break}}return e},a.Serve.getActiveHosts=function(b){var c=[];return a.Util.forEach(b,function(a,b){"stable"==a.connects[b].connection.signalingState&&c.push(b)}),c},a.Serve.cleanupHosts=function(b){var c=a.Serve.getActiveHosts(b);a.Util.forEach(b,function(a,d){-1==c.indexOf(d)&&delete b[d]})},a.Serve.handleBrokenRequests=function(b){var c=a.Global.init_info.hosts,d=a.Global.peer_asset_connections,e={};if(b in d){a.Util.forEach(a.Serve.requests[b],function(b,c){var d=b.chunks,f=b.chunks_received,g=a.Util.diffArray(d,f||[]);g.length&&(e[c]=e[c]||{},e[c].chunks=g)}),delete d[b];var f=a.Serve.getPeerHostInfo(b);if(c.splice(f.index,1),delete a.Serve.requests[b],a.Global.init_info.hosts.length&&a.Util.keys(e).length){var g=a.Util.first(c),h=d[g.id].channels.peerAssetsConnection;h.send(JSON.stringify(e))}else a.Serve.getAssetsFromServer({noWatcher:!0})}},a.Serve.buildAssetsRequestList=function(b){var c={},d=a.Cache.getCachedAssetList(),e=a.Util.diffArray(b,d);return a.Util.forEach(e,function(a){c[a]={finished:!1}}),c},a.Serve.getAssetsFromPeers=function(b){var c=a.Serve.getPeerHostedAssetsList(b.hosts),d=a.Util.arrayRemoveDuplicates(a.Cache.getCacheableAssetList()),e=a.Util.getArrayValuesEqual(d,a.Util.diffArray(d,c)),f=a.Util.diffArray(a.Util.getArrayValuesEqual(d,a.Util.diffArray(d,e)),a.Cache.getCachedAssetList());f.length&&(a.Serve.requests=a.Serve.buildAssetsRequestMessage({hosts:b.hosts,assets:f}),a.Log.trace("v.Serve.requests",a.Serve.requests),a.Serve.request_watchers=a.Serve.buildAssetsRequestTracker(a.Serve.requests)),a.Serve.initGlobalStatusWatcher(d),f.length&&a.Util.forEach(a.Global.init_info.hosts,function(c){var d=a.Serve.startAssetRequestListener({id:c.id,socket:b.socket,handleRequest:a.Serve.handleSendingAssetRequest});d.openListeningChannel({client_id:b.self.id,channel_id:"peerAssetsConnection",connection_id:c.id,onDataChannelOpen:function(b){b.channel.send(JSON.stringify(a.Serve.requests[c.id]))},onDataChannelMessage:function(b){a.Serve.handleReceivingRequest(b)},onDataChannelClose:function(b){a.Serve.handleBrokenRequests(b.peer_id)},onDataChannelError:function(){}})}),e.length&&a.Serve.getAssetsFromServer({assets:e})},a.Serve.getAssetsFromServer=function(b){var c=null;b.assets?c=b.assets:(c=a.Cache.getCacheableAssetList(),b.noWatcher||a.Serve.initGlobalStatusWatcher(c)),a.Cache.getAllAssetsFromServer({list:c,onReady:function(b,c){a.Log.trace("Downloaded asset from server: ",c),a.Global.watcher.assets[c].finished=!0}})},a}(vcdn||{}),function(a){return a.P2PS=function(a){var b=function(a){return{socket:a.socket,send:function(a,b,c,d){this.socket.emit("P2PC_SendMessageToPeer",{handler:a,peer_id:b,client_id:c,message:d})},onmessage:function(a,b){this.socket.on(a,function(a){b.call(this,a)})}}};return b(a)},a}(vcdn||{}),function(a){return a.P2PC=function(b){var c=function(b){return{id:b.id,p2ps:b.signal,connects:b.connects||{},channels:b.channels||{},p2pc_config:b.p2pc_config||a.Global.p2pc.p2pc_config||{optional:[{DtlsSrtpKeyAgreement:!0},{RtpDataChannels:!0}]},dc_config:b.dc_config||a.Global.p2pc.dc_config||{ordered:!0,reliable:!1},stun_config:b.stun_config||a.Global.p2pc.stun_config||[{url:"stun:23.21.150.121"},{url:"stun:stun.l.google.com:19302"}],p2pc_handler:{onaddstream:b.onaddstream||function(b){a.Log.trace("onaddstream::",b)},onclosedconnection:b.onclosedconnection||function(b){a.Log.trace("onclosedconnection::",b)},onicecandidate:b.onicecandidate||function(b){a.Log.trace("onicecandidate::",b)},onconnectionstatechange:b.onconnectionstatechange||function(b){a.Log.trace("onconnectionstatechange::",b)},onnegotiationneeded:b.onnegotiationneeded||function(b){a.Log.trace("onnegotionationneeded::",b)},onremovestream:b.onremovestream||function(b){a.Log.trace("onremovestream::",b)},onsignalingstatechange:b.onsignalingstatechange||function(b){a.Log.trace("onsignalingstatechange::",b)},ondatachannel:b.ondatachannel||function(b){a.Log.trace("ondatachannel::",b)}},dc_handler:{onopen:b.onopen||function(b){a.Log.trace("onopen::",b)},onerror:b.onerror||function(b){a.Log.trace("onerror::",b)},onmessage:b.onmessage||function(b){a.Log.trace("onmessage::",b)},onclose:b.onclose||function(b){a.Log.trace("onclose::",b)}},extend:function(){var b=a.Util.toArray(arguments),c=b.shift();return b.forEach(function(a){for(var b in a)c[b]=a[b]}),c},newListeningChannel:function(a){var b=this,c=this.p2ps,d="",e=a.p2pc_config||this.p2pc_config,f=a.onDataChannelReady;c.onmessage(a.channel_id,function(g){var h=g.message;"offer"==h.type?(d=g.peer_id,b.newPeerConnection({connection_id:d,p2pc_config:e,p2pc_handler:{ondatachannel:function(a){var c=a.channel;b.newDataChannel({id:a.channel.label,channel:c}),c.onmessage=function(a){f&&f.apply(this,[{"this":this,channel:c,data:a.data,message:g,event:a}])}}}}),b.answerPeerOffer(d,h,function(b){c.send(a.channel_id,g.client_id,g.peer_id,b)})):"answer"==h.type&&(d=g.client_id,b.setRemoteDescription(d,h))})},openListeningChannel:function(a){var b=this,c=this.p2ps,d=a.client_id,e=a.channel_id,f=a.connection_id,g=a.p2pc_config||this.p2pc_config,h=a.dc_config||this.dc_config,i=a.dc_handler||{},j=b.getConnection(f),k=a.onDataChannelMessage,l=a.onDataChannelOpen,m=a.onDataChannelClose||this.dc_handler.onclose,n=a.onDataChannelError||this.dc_handler.onerror;j||b.newPeerConnection({connection_id:f,p2pc_config:g}),b.newDataChannel({channel_id:e,connection_id:f,dc_config:h,dc_handler:this.extend({onopen:function(a){l.apply(this,[{channel:b.getDataChannel(f,e),peer_id:f,event:a}])},onmessage:function(a){k.apply(this,[{channel:b.getDataChannel(f,e),peer_id:f,data:a.data,event:a}])},onclose:function(a){m.apply(this,[{channel:b.getDataChannel(f,e),peer_id:f,event:a}])},onerror:function(a){n.apply(this,[{channel:b.getDataChannel(f,e),peer_id:f,event:a}])}},i)}),j||b.createClientOffer(f,function(a){c.send(e,f,d,a)})},newPeerConnection:function(a){var b=a.connection_id,c=a.p2pc_config||this.p2pc_config,d=a.p2pc_handler||this.p2pc_handler;this.connects[b]={id:b,sdp_offer:null,sdp_answer:null,connection:new PeerConnection(this.stun_config,c),peer_connection:null};for(var e in this.p2pc_handler)e in d||!this.p2pc_handler[e]||(d[e]=this.p2pc_handler[e]);for(var f in d)d[f]&&(this.connects[b].connection[f]=d[f]);return this.connects[b].connection},newDataChannel:function(a){var b=a.id||a.channel_id,c=a.channel||null,d=a.dc_config||this.dc_config,e=a.dc_handler||this.dc_handler;this.channels[b]=c?c:this.connects[a.connection_id].connection.createDataChannel(b,d);for(var f in e)this.channels[b][f]=e[f];return this.channels[b]},setRemoteDescription:function(b,c,d){if(b in this.connects){var e=this.connects[b];e.connection.setRemoteDescription(new SessionDescription(c),function(){d&&d.call(this,e,b,c)},a.Log.trace)}},createClientOffer:function(b,c){var d=this.connects[b];d.connection.createOffer(function(b){d.sdp_offer=b,d.connection.setLocalDescription(b,function(){c&&c.call(this,b)},a.Log.trace)},a.Log.trace)},answerPeerOffer:function(b,c,d){var e=this.connects[b];e.connection.setRemoteDescription(new SessionDescription(c),function(){e.connection.createAnswer(function(a){e.connection.setLocalDescription(a),d&&d.call(this,a)},a.Log.trace)},a.Log.trace)},getConnection:function(a){return a in this.connects?this.connects[a]:!1},getDataChannel:function(a,b){var c=b;return c in this.channels?this.channels[c]:!1}}};return c(b)},a}(vcdn||{});var vcdn=function(a){var b=setInterval(function(){window.io&&(clearInterval(b),c())},10),c=function(){var b=a.Global.socket=io.connect();a.Serve.registerAsHost({ready:!1}),b.on("ready",function(c){a.Log.trace("initInfo",c),a.Log.trace("initInfo.hosts",c.hosts),c.self.diff_time=a.Util.timestamp(-c.self.vcdn_time),c.expired=[],a.Global.init_info=c,a.Cache.uncacheDeadAssets(),a.Cache.loadAllCachedAssets(),c.hosts.length?c.hosts.length&&(a.Log.trace("vcdn ready: ","condition 2"),a.Serve.getAssetsFromPeers({hosts:c.hosts,self:c.self,socket:b})):(a.Log.trace("vcdn ready: ","condition 1"),a.Serve.getAssetsFromServer({}),a.Serve.startAssetRequestListener({id:a.Global.init_info.self.id,socket:a.Global.socket,handleRequest:a.Serve.handleSendingAssetRequest}))})};return function(){return{}}}(vcdn||{});